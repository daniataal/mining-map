name: Docker Image CI and Remote Deployment

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Log in to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Set Build Version
      id: version
      run: |
        echo "BUILD_NUMBER=${{ github.run_number }}" >> $GITHUB_ENV

    - name: Build and Push Docker Image
      run: |
        docker build . --file Dockerfile --tag dannyatalla/mining-map:v${{ env.BUILD_NUMBER }}
        docker push dannyatalla/mining-map:v${{ env.BUILD_NUMBER }}

    # SSH into the remote server and deploy the container
    - name: Deploy to remote server
      uses: appleboy/ssh-action@v1.1.0
      with:
        host: ${{ secrets.REMOTE_HOST }}
        username: ${{ secrets.REMOTE_USER }}
        port: 22  # Adjust if you're using a different port
        key: ${{ secrets.REMOTE_SSH_KEY }}  # Directly using SSH key here
        script: |
          APP_IMAGE="dannyatalla/mining-map:v${{ env.BUILD_NUMBER }}"
          
          # Ensure directory exists
          sudo mkdir -p /opt/mining-map
          cd /opt/mining-map

          # Create/Overwrite docker-compose.yml
          cat <<EOF | sudo tee docker-compose.yml
          version: '3.8'
          services:
            app:
              image: $APP_IMAGE
              ports:
                - "8000:8000"
                - "5173:5173"
              environment:
                - VITE_API_BASE=http://129.159.148.51:8000
                - DB_HOST=db
                - DB_NAME=mining_db
                - DB_USER=postgres
                - DB_PASSWORD=password
              depends_on:
                - db
              restart: always

            db:
              image: postgres:15
              environment:
                POSTGRES_DB: mining_db
                POSTGRES_USER: postgres
                POSTGRES_PASSWORD: password
              volumes:
                - postgres_data:/var/lib/postgresql/data
              restart: always

          volumes:
            postgres_data:
          EOF

          # Pull latest image
          sudo docker pull $APP_IMAGE

          # Stop old containers if running via independent docker run (cleanup)
          sudo docker rm -f mining-map-auto || true

          # Start up with Compose
          if sudo docker compose version >/dev/null 2>&1; then
            sudo docker compose up -d --remove-orphans
          else
            sudo docker-compose up -d --remove-orphans
          fi
